import os
os.environ["ENVIRONMENT"] = "dev"
from aws_xray_sdk.core import xray_recorder
xray_recorder.configure(sampling=False)
xray_recorder.begin_segment(name="dev")
xray_recorder._max_subsegments = 30

from fathomapi.api.config import Config

Config.set('PROVIDER_INFO', {'exercise_library_filename': 'exercise_library_fathom.json',
                             'body_part_mapping_filename': 'body_part_mapping_fathom.json',
                             'movement_library_filename': 'movement_library_soflete.json',
                                 'cardio_data_filename': 'cardiorespiratory_data_soflete.json',
                                 'hr_rpe_model_filename': 'hr_rpe.joblib',
                                 'bodyweight_ratio_model_filename': 'bodyweight_ratio.joblib',
                                 'model_bucket': 'biometrix-globalmodels'})
from datastores.symptom_datastore import SymptomDatastore
from datastores.datastore_collection import DatastoreCollection
from datastores.training_session_datastore import TrainingSessionDatastore
from datastores.workout_program_datastore import WorkoutProgramDatastore
from datastores.athlete_stats_datastore import AthleteStatsDatastore
from datastores.daily_plan_datastore import DailyPlanDatastore
from models.stats import AthleteStats
from models.user_stats import UserStats
from logic.training_plan_management import TrainingPlanManager
from logic.athlete_status_processing import AthleteStatusProcessing

from logic.stats_processing import StatsProcessing
import datetime
from utils import parse_datetime, format_datetime, format_date, validate_uuid4, fix_early_survey_event_date
from logic.survey_processing import create_plan, cleanup_plan

from logic.user_stats_processing import UserStatsProcessing
from logic.injury_risk_processing import InjuryRiskProcessor
from logic.api_processing import APIProcessing
from logic.activity_management import ActivityManager
from datastores.injury_risk_datastore import InjuryRiskDatastore

from models.athlete_injury_risk import AthleteInjuryRisk
### dev
athlete_id = "fd263811-b299-461f-9e79-895c69612bac"  # dipesh+mvp

event_date_time = parse_datetime(format_datetime(datetime.datetime.now()))

user_stats = DatastoreCollection().user_stats_datastore.get(athlete_id)
api_processor = APIProcessing(user_id=athlete_id, event_date_time=event_date_time, user_stats=user_stats)
another_workout = {
    "name": "run",
    "duration_seconds": 3968,
    "workout_sections": [
        {
            "name": "workout",
            "duration_seconds": 3968,
            "exercises": [
                {
                    "name": "free run",
                    "distance": 7286.83,
                    "duration": 3968,
                    "speed": 2.1531463414634144,
                    "movement_id": "run",
                    "hr": [
                        97.0,
                        96.0,
                        95.0,
                        98.0,
                        101.0,
                        105.0,
                        108.0,
                        113.0,
                        118.0,
                        121.0,
                        124.0,
                        127.0,
                        128.0,
                        132.0,
                        131.0,
                        128.0,
                        125.0,
                        121.0,
                        121.0,
                        124.0,
                        123.0,
                        121.0,
                        121.0,
                        122.0,
                        122.0,
                        123.0,
                        123.0,
                        124.0,
                        126.0,
                        125.0,
                        122.0,
                        126.0,
                        126.0,
                        129.0,
                        131.0,
                        134.0,
                        136.0,
                        136.0,
                        137.0,
                        137.0,
                        137.0,
                        138.0,
                        138.0,
                        141.0,
                        141.0,
                        142.0,
                        141.0,
                        142.0,
                        141.0,
                        140.0,
                        138.0,
                        137.0,
                        136.0,
                        138.0,
                        140.0,
                        139.0,
                        139.0,
                        139.0,
                        139.0,
                        139.0,
                        139.0,
                        138.0,
                        137.0,
                        136.0,
                        137.0,
                        138.0,
                        137.0,
                        137.0,
                        138.0,
                        138.0,
                        139.0,
                        139.0,
                        140.0,
                        139.0,
                        139.0,
                        139.0,
                        139.0,
                        139.0,
                        139.0,
                        140.0,
                        140.0,
                        138.0,
                        138.0,
                        138.0,
                        139.0,
                        140.0,
                        142.0,
                        142.0,
                        142.0,
                        142.0,
                        142.0,
                        140.0,
                        139.0,
                        139.0,
                        140.0,
                        141.0,
                        140.0,
                        139.0,
                        137.0,
                        137.0,
                        137.0,
                        136.0,
                        137.0,
                        138.0,
                        139.0,
                        139.0,
                        140.0,
                        140.0,
                        141.0,
                        141.0,
                        140.0,
                        141.0,
                        143.0,
                        143.0,
                        143.0,
                        142.0,
                        142.0,
                        143.0,
                        143.0,
                        142.0,
                        141.0,
                        140.0,
                        140.0,
                        142.0,
                        142.0,
                        143.0,
                        140.0,
                        141.0,
                        139.0,
                        137.0,
                        136.0,
                        134.0,
                        133.0,
                        93.0,
                        91.0,
                        88.0,
                        88.0,
                        87.0,
                        87.0,
                        88.0,
                        91.0,
                        91.0,
                        96.0,
                        99.0,
                        104.0,
                        107.0,
                        107.0,
                        109.0,
                        111.0,
                        114.0,
                        116.0,
                        118.0,
                        120.0,
                        123.0,
                        123.0,
                        121.0,
                        122.0,
                        123.0,
                        129.0,
                        130.0,
                        130.0,
                        132.0,
                        133.0,
                        135.0,
                        136.0,
                        136.0,
                        136.0,
                        94.0,
                        95.0,
                        91.0,
                        89.0,
                        93.0,
                        97.0,
                        100.0,
                        104.0,
                        107.0,
                        107.0,
                        110.0,
                        111.0,
                        115.0,
                        116.0,
                        119.0,
                        122.0,
                        125.0,
                        127.0,
                        128.0,
                        127.0,
                        127.0,
                        127.0,
                        129.0,
                        130.0,
                        132.0,
                        133.0,
                        134.0,
                        135.0,
                        135.0,
                        134.0,
                        132.0,
                        129.0,
                        129.0,
                        128.0,
                        127.0,
                        126.0,
                        125.0,
                        125.0,
                        125.0,
                        124.0,
                        125.0,
                        125.0,
                        125.0,
                        123.0,
                        123.0,
                        122.0,
                        123.0,
                        123.0,
                        124.0,
                        125.0,
                        125.0,
                        123.0,
                        123.0,
                        123.0,
                        115.0,
                        116.0,
                        117.0,
                        119.0,
                        119.0,
                        120.0,
                        121.0,
                        124.0,
                        125.0,
                        126.0,
                        129.0,
                        131.0,
                        132.0,
                        135.0,
                        137.0,
                        137.0,
                        138.0,
                        138.0,
                        139.0,
                        140.0,
                        140.0,
                        141.0,
                        142.0,
                        141.0,
                        142.0,
                        142.0,
                        142.0,
                        142.0,
                        141.0,
                        140.0,
                        138.0,
                        137.0,
                        137.0,
                        136.0,
                        135.0,
                        134.0,
                        132.0,
                        131.0,
                        129.0,
                        128.0,
                        123.0,
                        124.0,
                        126.0,
                        128.0,
                        131.0,
                        131.0,
                        134.0,
                        135.0,
                        135.0,
                        137.0,
                        137.0,
                        136.0,
                        136.0,
                        137.0,
                        137.0,
                        137.0,
                        138.0,
                        139.0,
                        140.0,
                        141.0,
                        142.0,
                        143.0,
                        143.0,
                        143.0,
                        142.0,
                        142.0,
                        142.0,
                        143.0,
                        144.0,
                        144.0,
                        144.0,
                        143.0,
                        142.0,
                        142.0,
                        141.0,
                        140.0,
                        141.0,
                        140.0,
                        138.0,
                        138.0,
                        135.0,
                        132.0,
                        132.0,
                        132.0,
                        131.0,
                        128.0,
                        128.0,
                        125.0,
                        125.0,
                        122.0,
                        121.0,
                        118.0,
                        119.0,
                        116.0,
                        116.0,
                        115.0,
                        112.0,
                        109.0,
                        108.0,
                        108.0,
                        111.0,
                        113.0,
                        116.0,
                        116.0,
                        118.0,
                        119.0,
                        119.0,
                        118.0,
                        118.0,
                        117.0,
                        117.0,
                        118.0,
                        119.0,
                        120.0,
                        120.0,
                        120.0,
                        120.0,
                        119.0,
                        120.0,
                        122.0,
                        124.0,
                        126.0,
                        126.0,
                        125.0,
                        125.0,
                        125.0,
                        125.0,
                        125.0,
                        126.0,
                        126.0,
                        127.0,
                        130.0,
                        130.0,
                        133.0,
                        133.0,
                        133.0,
                        133.0,
                        132.0,
                        132.0,
                        132.0,
                        131.0,
                        131.0,
                        130.0,
                        130.0,
                        129.0,
                        128.0,
                        127.0,
                        127.0,
                        127.0,
                        128.0,
                        127.0,
                        127.0,
                        127.0,
                        127.0,
                        129.0,
                        130.0,
                        131.0,
                        131.0,
                        130.0,
                        133.0,
                        133.0,
                        134.0,
                        134.0,
                        134.0,
                        133.0,
                        132.0,
                        132.0,
                        131.0,
                        132.0,
                        132.0,
                        132.0,
                        132.0,
                        133.0,
                        134.0,
                        132.0,
                        130.0,
                        130.0,
                        132.0,
                        133.0,
                        133.0,
                        135.0,
                        135.0,
                        134.0,
                        137.0,
                        137.0,
                        137.0,
                        137.0,
                        137.0,
                        138.0,
                        140.0,
                        141.0,
                        143.0,
                        141.0,
                        143.0,
                        141.0,
                        142.0,
                        142.0,
                        140.0,
                        142.0,
                        142.0,
                        141.0,
                        140.0,
                        140.0,
                        140.0,
                        139.0,
                        139.0,
                        138.0,
                        140.0,
                        140.0,
                        141.0,
                        143.0,
                        142.0,
                        141.0,
                        141.0,
                        140.0,
                        134.0,
                        131.0,
                        131.0,
                        132.0,
                        132.0,
                        134.0,
                        132.0,
                        133.0,
                        136.0,
                        139.0,
                        139.0,
                        138.0,
                        139.0,
                        141.0,
                        143.0,
                        143.0,
                        142.0,
                        143.0,
                        141.0,
                        140.0,
                        141.0,
                        141.0,
                        140.0,
                        140.0,
                        139.0,
                        140.0,
                        140.0,
                        141.0,
                        143.0,
                        144.0,
                        146.0,
                        145.0,
                        144.0,
                        143.0,
                        142.0,
                        140.0,
                        140.0,
                        139.0,
                        138.0,
                        137.0,
                        137.0,
                        140.0,
                        141.0,
                        141.0,
                        141.0,
                        140.0,
                        139.0,
                        139.0,
                        139.0,
                        139.0,
                        138.0,
                        137.0,
                        137.0,
                        136.0,
                        136.0,
                        138.0,
                        139.0,
                        140.0,
                        141.0,
                        141.0,
                        143.0,
                        143.0,
                        145.0,
                        145.0,
                        146.0,
                        146.0,
                        148.0,
                        149.0,
                        147.0,
                        146.0,
                        145.0,
                        144.0,
                        145.0,
                        146.0,
                        145.0,
                        142.0,
                        142.0,
                        141.0,
                        141.0,
                        143.0,
                        144.0,
                        143.0,
                        142.0,
                        142.0,
                        143.0,
                        144.0,
                        144.0,
                        143.0,
                        144.0,
                        143.0,
                        144.0,
                        144.0,
                        146.0,
                        143.0,
                        143.0,
                        146.0,
                        145.0,
                        143.0,
                        141.0,
                        139.0,
                        138.0,
                        140.0,
                        141.0,
                        141.0,
                        142.0,
                        142.0,
                        139.0,
                        139.0,
                        140.0,
                        141.0,
                        141.0,
                        140.0,
                        140.0,
                        141.0,
                        141.0,
                        141.0,
                        141.0,
                        141.0,
                        142.0,
                        142.0,
                        142.0,
                        142.0,
                        141.0,
                        141.0,
                        141.0,
                        140.0,
                        141.0,
                        141.0,
                        142.0,
                        141.0,
                        139.0,
                        138.0,
                        137.0,
                        137.0,
                        139.0,
                        140.0,
                        139.0,
                        140.0,
                        139.0,
                        138.0,
                        138.0,
                        140.0,
                        141.0,
                        141.0,
                        141.0,
                        141.0,
                        139.0,
                        139.0,
                        139.0,
                        139.0,
                        139.0,
                        138.0,
                        139.0,
                        139.0,
                        115.0,
                        115.0,
                        116.0,
                        118.0,
                        119.0,
                        121.0,
                        122.0,
                        123.0,
                        125.0,
                        127.0,
                        128.0,
                        131.0,
                        131.0,
                        133.0,
                        135.0,
                        137.0,
                        140.0,
                        140.0,
                        141.0,
                        142.0,
                        142.0,
                        143.0,
                        140.0,
                        140.0,
                        137.0,
                        137.0,
                        137.0,
                        136.0,
                        136.0,
                        136.0,
                        137.0,
                        137.0,
                        137.0,
                        138.0,
                        139.0,
                        141.0,
                        141.0,
                        142.0,
                        143.0,
                        145.0,
                        146.0,
                        146.0,
                        146.0,
                        145.0,
                        143.0,
                        140.0,
                        138.0,
                        137.0,
                        135.0,
                        137.0,
                        138.0,
                        138.0,
                        137.0,
                        138.0,
                        136.0,
                        137.0,
                        137.0,
                        137.0,
                        138.0,
                        139.0,
                        139.0,
                        140.0,
                        140.0,
                        141.0,
                        138.0,
                        138.0,
                        140.0,
                        140.0,
                        140.0,
                        141.0,
                        140.0,
                        140.0,
                        142.0,
                        142.0,
                        141.0,
                        142.0,
                        140.0,
                        140.0,
                        140.0,
                        141.0,
                        141.0,
                        139.0,
                        139.0,
                        139.0,
                        139.0,
                        136.0,
                        136.0,
                        136.0,
                        136.0,
                        137.0,
                        136.0,
                        135.0,
                        133.0,
                        135.0,
                        135.0,
                        135.0,
                        137.0,
                        138.0,
                        140.0,
                        141.0,
                        141.0,
                        141.0,
                        143.0,
                        141.0,
                        141.0,
                        140.0,
                        139.0
                    ]
                }
            ],
            "start_date_time": "2020-07-19T11:57:40",
            "end_date_time": "2020-07-19T13:03:48"
        }
    ],
    "distance": 7286.83
}
#
session = {
        "event_date": "2020-03-13T14:41:57-0500",
        "session_type": 7,
        "duration": 840,
        "description": "Evening Practice",
        "calories": 100,
        "distance": 200,
        "session_RPE": 7.3,
        "end_date": "2020-03-13T14:54:57-0500",
        # "hr_data": [
        #     {"value": 153,
        #      "startDate": "2019-01-12T10:43:08.490-0500",
        #      "endDate": "2019-01-12T10:43:08.490-0500"
        #      }
        # ],
        # "workout_program_module": workout_program_long
        "workout_program_module": another_workout
    }
# process completed session
if session is not None:
    api_processor.create_session_from_survey(session)


responsive_recovery = api_processor.create_activity(
        activity_type='responsive_recovery'
)