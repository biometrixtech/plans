# Plans API

## Common provisions

#### Terminology

The terminology of [RFC 2119](https://www.ietf.org/rfc/rfc2119.txt) (specifically __must__, __should__, __may__ and their negatives) applies.  The word __will__, when applied to the Plans API ("the API"), has the same meaning as __must__.

#### Protocol

The API supports communication over HTTPS only.

#### Encoding

The API supports communication using JSON encoding only.  The client __must__ submit the headers `Content-Type: application/json` and `Accept: application/json` for all requests.  Failure to do so __will__ result in a `415 Unsupported Media Type` response.  The API __will__ include the header `Content-Type: application/json` with its response.

#### Authentication

Unless otherwise specified, the endpoints in the API are authenticated by a JWT bearer token.  One token source are accepted:

* Tokens generated by Amazon Cognito and acquired as part of authentication to the Users Service;

The client __must__ submit the header `Authorization: <JWT>` with all requests. Failure to do so, or submitting an invalid or expired JWT, __will__ result in a `401 Unauthorized` response.  

#### General responses

In addition to the AWS API Gateway responses and the specific responses for each endpoint, the server __may__ respond with one of the following HTTP responses:

* `400 Bad Request` with `Status` header equal to `InvalidSchema`, if the JSON body of the request does not match the requirements of the endpoint.
* `404 Unknown` with `Status` header equal to `UnknownEndpoint`, if an invalid endpoint was requested.

## Schema

### Simple

The following simple types __may__ be used in responses:

* `string`, `number`: as defined in the [JSON Schema](http://json-schema.org) standard.
* `Uuid`: a `string` matching the regular expression `^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$`, that is, the string representation of an [RFC 4122](https://tools.ietf.org/html/rfc4122) UUID.
* `Datetime`: a `string` matching the regular expression `/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(Z|+\d{2}:\d{2})/` and representing a date and time in full [ISO 8601](https://www.iso.org/iso-8601-date-and-time-format.html) format.

## Endpoints

### Daily Readiness

#### Create

This endpoint can be called to register a new daily readiness survey.

##### Query String
 
The client __must__ submit a request to the endpoint `/plans/daily_readiness`. The request method __must__ be `POST`.

##### Request

The client __must__ submit a request body containing a JSON object with the following schema:
```
{
	"date_time": Datetime,
	"user_id": Uuid,
	"soreness": [{"body_part": number, "severity": number, "side": number}],
	"sleep_quality": number,
	"readines": number
}
```
* `date_time` __should__ reflect the local time that survey was taken
* `soreness` __should__ reflect the number of body part that the user indicated soreness. Length __could__ be 0.
* `body_part` __should__ be an integer between 0 and 17
* `severity` __should__ be an integer between 1 and 5
* `side` __should__ be an integer between 0 and 2
* `sleep_quality` __should__ be an integer between 1 and 10
* `readiness` __should__ be an integer between 1 and 10

```
POST /plans/daily_readiness HTTPS/1.1
Host: apis.env.fathomai.com
Content-Type: application/json
Authorization: eyJraWQ...ajBc4VQ

{
	"date_time": "2018-07-03T10:42:20Z",
	"user_id":"02cb7965-7921-493a-80d4-6b278c928fad",
	"soreness":[
			{"body_part": 8, "severity": 2, "side": 0},
			{"body_part": 14, "severity": 3, "side": 0}
		   ],
	"sleep_quality":4,
	"readiness":10
}
```
##### Responses
 
 If the write was successful, the Service __will__ respond with HTTP Status `201 Created`, with a body with the following syntax:
 
```
{
    "message": "success"
}
```


#### Soreness from previous survey

This endpoint can be called to get the body parts where soreness was reported in the last report.

##### Query String
 
The client __must__ submit a request to the endpoint `/plans/daily_readiness/previous`. The request method __must__ be `GET`.

##### Request
This request does not require a body.


```
GET /plans/daily_readiness/previous HTTPS/1.1
Host: apis.env.fathomai.com
Content-Type: application/json
Authorization: eyJraWQ...ajBc4VQ

```
Authentication is required for this endpoint

##### Responses
 
 The Service __will__ respond with HTTP Status `200 OK`, with a body with the following syntax:
 
```
{
    "body_parts": [
    		{"body_part": number, "side": number},
    		{"body_part": number,"side": number}
    		]
}
```
* body_part will be a list of enumerated body parts (potentially empty).



### Post-Session Survey

#### Create

This endpoint can be called to register a a post-session survey.

##### Query String
 
The client __must__ submit a request to the endpoint `/plans/post_session_survey`. The request method __must__ be `POST`.

##### Request

The client __must__ submit a request body containing a JSON object with the following schema:
```
{
	"user_id": Uuid,
	"event_date": Datetime,
	"session_id": Uuid,
	"session_type": number,
	"survey": {
		"RPE": number,
		"soreness": [{"body_part": number, "severity": number, "side": number}]
	}
}
```
* `event_date` __should__ reflect the date and time when the survey happened
* `session_id` __should__ be id of the session associated. It's __optional__ if the survey is associated with new session that doesn't exist in daily_plan
* `session_type` __should__ be an integer reflecting enumeration of different session type (0-5)
* `RPE` __should__ be an integer between 1 and 10
* `soreness` __should__ follow the same definition as in readiness_survey

```
POST /plans/post_session_survey HTTPS/1.1
Host: apis.env.fathomai.com
Content-Type: application/json
Authorization: eyJraWQ...ajBc4VQ

{
    "user_id": "02cb7965-7921-493a-80d4-6b278c928fad",
    "event_date": "2018-07-03",
    "session_id": "69223f69-08b2-4e61-be2a-0e9b38787cec",
    "session_type": 1,
    "survey": 
            {
               "RPE": 4,
               "soreness": [
               		{"body_part": 17.0, "severity": 5, "side": 0},
               		{"body_part": 14, "severity": 3, "side": 0}
               		]
            }
            
}
```
##### Responses
 
 If the write was successful, the Service __will__ respond with HTTP Status `201 Created`, with a body with the following syntax:
 
```
{
    "message": "success"
}
```


### Session

#### Create

This endpoint can be called to create a new session to be added to either today's or yesterday's plan.

##### Query String
 
The client __must__ submit a request to the endpoint `/plans/session`. The request method __must__ be `POST`.

##### Request

The client __must__ submit a request body containing a JSON object with the following schema:
```
{
	"user_id": Uuid,
	"event_date": Datetime,
	"session_type": number,
	"description": string
}
```
* `event_date` __should__ reflect the date the session should be created for and should be of format `yyyy-yy-yy`.
* `session_type` __should__ be an integer reflecting SessionType enumeration.
* `description` is __optional__ parameter to provide short description of the session they're adding

```
POST /plans/session HTTPS/1.1
Host: apis.env.fathomai.com
Content-Type: application/json
Authorization: eyJraWQ...ajBc4VQ

{
    "user_id": "morning_practice_2",
    "event_date": "2018-07-11",
    "session_type": 0,
    "description": "evening biking"
}
```
##### Responses
 
 If the write was successful, the Service __will__ respond with HTTP Status `201 Created`, with a body with the following syntax:
 
```
{
    "message": "success"
}
```

#### Delete

This endpoint can be called to delete existing externally regimented session from today or yesterday's plan.

##### Query String
 
The client __must__ submit a request to the endpoint `/plans/session/{session_id}`. The request method __must__ be `DELETE`.

##### Request

The client __must__ submit a request body containing a JSON object with the following schema:
```
{
	"user_id": Uuid,
	"event_date": Datetime,
	"session_type": number
}
```
* `event_date` __should__ reflect the date the session should be created for and should be of format `yyyy-mm-dd`.
* `session_type` __should__ be an integer reflecting SessionType enumeration.

```
DELETE /plans/session/73e8f603-d2d5-423a-b2b6-fe0996a373c8 HTTPS/1.1
Host: apis.env.fathomai.com
Content-Type: application/json
Authorization: eyJraWQ...ajBc4VQ

{
    "user_id": "morning_practice_2",
    "event_date": "2018-07-11",
    "session_type": 1
}
```
##### Responses
 
 If the delete was successful, the Service __will__ respond with HTTP Status `200 OK`, with a body with the following syntax:
 
```
{
    "message": "success"
}
```


#### Send sensor data

This endpoint can be called to write sensor data for sessions(s)

##### Query String
 
The client __must__ submit a request to the endpoint `/plans/session/sensor_data`. The request method __must__ be `POST`.

##### Request

The client __must__ submit a request body containing a JSON object with the following schema:
```
{
    "user_id": Uuid,
    "sessions": [Session]
}
```
A `Session` object __will__ have the following schema:

```
{
    "session_id": Uuid,
    "session_type": number,
    "event_date": Datetime
    "start_time": Datetime,
    "end_time": Datetime,
    "inactive_duration": number,
    "low_duration": number, 
    "mod_duration": number,
    "high_duration": number,
    "inactive_accel": number,
    "low_accel": number, 
    "mod_accel": number,
    "high_accel": number

}
```
* `session_id` , `session_type` and `event_date` are optional arguments


```
POST /plans/session/sensor_data HTTPS/1.1
Host: apis.env.fathomai.com
Content-Type: application/json
Authorization: eyJraWQ...ajBc4VQ

{
    "user_id": "e8514489-8de9-47e0-b3d5-b15da244783f",
    "sessions":
    [
        {
            "start_time": "2018-07-18T13:40:20Z",
            "end_time": "2018-07-18T14:40:20Z",
            "inactive_duration": 1500,
            "low_duration": 500, 
            "mod_duration": 200,
            "high_duration": 60,
            "inactive_accel": 1500,
            "low_accel": 500, 
            "mod_accel": 200,
            "high_accel": 60
        }
    ]
}
```
##### Responses
 
 If all sessions were updated successfully, the Service __will__ respond with HTTP Status `200 OK`, with a body with the following syntax:
 
```
{
    "message": "success"
}
```


### Schedule

#### Daily Schedule
This API can be used to submit athlete's daily schedule when they first open the app.

##### Query String
The client __must__ submit a request to the endpoint `/plans/daily_schedule`. The request method __must__ be `POST`.

##### Request
The client __must__ submit a request body containing a JSON object with the following schema:
```
{
    "user_id": Uuid,
    "event_date": Datetime
    "sessions": [Session, Session]
}
```
* `event_date` __should__ be of format `yyyy-mm-dd`
* `Session` object __should__ have the following schema
```
    {
        "session_type": number,
        "start_time": Datetime,
        "duration": number,
        "description": string
    }
```
* `start_time` should reflect the date and time when the session is scheduled
* `duration` should be in minutes

```
POST /plans/daily_schedule HTTPS/1.1
Host: apis.env.fathomai.com
Content-Type: application/json
Authorization: eyJraWQ...ajBc4VQ

{
    "user_id": "dipesh",
    "event_date": "2018-07-26",
    "sessions":
    [
        {
            "session_type": 0,
            "start_time": "2018-07-26T07:30:00Z",
            "duration": 90,
            "descrption": "Morning Practice"
        },
        {
            "session_type": 1,
            "start_time": "2018-07-26T19:30:00Z",
            "duration": 30,
            "description": "Evening Biking"
        }
        ]
}
```
##### Responses
 
 If the write was successful, the Service __will__ respond with HTTP Status `201 Created`, with a body with the following syntax:
 
```
{
    "message": "success"
}
```

### Weekly Training

#### Cross-Training

##### Query String
The client __must__ submit a request to the endpoint `/plans/weekly_schedule/cross_training`. The request method __must__ be `POST`.

##### Request
The client __must__ submit a request body containing a JSON object with the following schema:
```
{
	"user_id": Uuid,
	"activities": [string, string],
	"days_of_week": [number, number]
	"duration": number
}
```
* `activities` __should__ reflect the list of cross-training activities user performs in the week
* `days_of_week` __should__ be a list of days of the week that the user plans to perform the activities encoded 0-Monday ... 6-Sunday
* `duration` __should__ be an integer representing average minutes per session

```
POST /plans/weekly_schedule/cross_training HTTPS/1.1
Host: apis.env.fathomai.com
Content-Type: application/json
Authorization: eyJraWQ...ajBc4VQ

{
    "user_id": "02cb7965-7921-493a-80d4-6b278c928fad",
    "activities": ["cycling", "weightlifting", "yoga"],
    "days_of_week": [0,1,4],
    "duration": 50
}
```
##### Responses
 
 If the write was successful, the Service __will__ respond with HTTP Status `201 Created`, with a body with the following syntax:
 
```
{
    "message": "success"
}
```

#### Training

##### Query String
The client __must__ submit a request to the endpoint `/plans/weekly_schedule/training`. The request method __must__ be `POST`.

##### Request
The client __must__ submit a request body containing a JSON object with the following schema:
```
{
	"user_id": Uuid,
	"sports": [sport1, sport2]
}
```
Where sports is the weekly schedule for a sport of the following schema:
```
{
	"sport": string,
	"practice": {
		"days_of_week": [number, number],
		"duration": number
		},
	"competition": {
		"days_of_week": [number]
	}
}

```
###### Example
```
POST /plans/weekly_schedule/training HTTPS/1.1
Host: apis.env.fathomai.com
Content-Type: application/json
Authorization: eyJraWQ...ajBc4VQ

{
    "user_id": "02cb7965-7921-493a-80d4-6b278c928fad",
	"sports": [
        {"sport": "sportX",
		"practice": {
			"days_of_week": [0, 1, 2, 3, 4, 5],
			"duration": 90
		},
		"competition": {
			"days_of_week": [6]
		}
	},
    { "sport": "sportY",
		"practice": {
			"days_of_week": [0, 1, 2, 3, 4, 5],
			"duration": 90
		},
		"competition": {
			"days_of_week": [6]
		}
	}
        ]
}
```
##### Responses
 
 If the write was successful, the Service __will__ respond with HTTP Status `201 Created`, with a body with the following syntax:
 
```
{
    "message": "success"
}
```


### Daily Plans

#### Get daily plan

##### Query String
The client __must__ submit a request to the endpoint `/plans/daily_plan`. The request method __must__ be `POST`.

##### Request
The client __must__ submit a request body containing a JSON object with the following schema:
```
{
	"user_id": Uuid,
	"start_date": string,
	"end_date": string
}
```
* `start_date` __should__ should be of format `yyyy-mm-dd`
* `end_date` __should__ should be of format `yyyy-mm-dd` but is __optional__

```
POST /plans/daily_plan HTTPS/1.1
Host: apis.env.fathomai.com
Content-Type: application/json
Authorization: eyJraWQ...ajBc4VQ

{
	"user_id": "test_user",
	"start_date": "2018-06-26",
	"end_date": "2018-06-27"
}
```
##### Responses
 
The Service __will__ respond with HTTP Status `200 OK`, with a body with the following syntax:
 
```
{
    "daily_plans": [daily_plan1, daily_plan2]
}
```
* `daily_plans` __could__ be emply list
* each `daily_plan*` will be of following syntax:
```
{
    "daily_plans": [
        {
            "date": "2018-07-17",
            "practice_sessions": [],
            "bump_up_sessions": [],
            "strength_conditioning_sessions": [],
            "games": [],
            "corrective_sessions": [],
            "tournaments": [],
            "daily_readiness_survey_completed": true,
            "recovery_am": {
                "minutes_duration": 14,
                "start_time": "2018-07-17 00:00:00",
                "end_time": "2018-07-17 12:00:00",
                "impact_score": 3,
                "activate_exercises": [],
                "inhibit_exercises": [
                    {
                        "bilateral": true,
                        "library_id": "3",
                        "name": "SMR - Hamstrings",
                        "position_order": 0,
                        "reps_assigned": 30,
                        "seconds_duration": 60,
                        "seconds_per_rep": null,
                        "seconds_per_set": 30,
                        "sets_assigned": 1,
                        "unit_of_measure": "seconds"
                    }
                ],
                "integrate_exercises": [],
                "lengthen_exercises": [
                    {
                        "bilateral": true,
                        "library_id": "49",
                        "name": "Kneeling Hip Flexor Static Stretch",
                        "position_order": 7,
                        "reps_assigned": 30,
                        "seconds_duration": 60,
                        "seconds_per_rep": null,
                        "seconds_per_set": 30,
                        "sets_assigned": 1,
                        "unit_of_measure": "seconds"
                    }
                ]
            },
            "recovery_pm": {
                "minutes_duration": 14,
                "start_time": "2018-07-17 12:00:00",
                "end_time": "2018-07-18 00:00:00",
                "impact_score": 3,
                "inhibit_exercises": [
                    {
                        "bilateral": true,
                        "library_id": "3",
                        "name": "SMR - Hamstrings",
                        "position_order": 0,
                        "reps_assigned": 30,
                        "seconds_duration": 60,
                        "seconds_per_rep": null,
                        "seconds_per_set": 30,
                        "sets_assigned": 1,
                        "unit_of_measure": "seconds"
                    }
                ],
                "activate_exercises": [],
                "integrate_exercises": [],
                "lengthen_exercises": [
                    {
                        "bilateral": true,
                        "library_id": "49",
                        "name": "Kneeling Hip Flexor Static Stretch",
                        "position_order": 7,
                        "reps_assigned": 30,
                        "seconds_duration": 60,
                        "seconds_per_rep": null,
                        "seconds_per_set": 30,
                        "sets_assigned": 1,
                        "unit_of_measure": "seconds"
                    }
                ]
            }
        }
    ]
}
```

### Training Seasons

#### athlete seasons

##### Query String
The client __must__ submit a request to the endpoint `/plans/athlete_seasons`. The request method __must__ be `POST`.

##### Request
The client __must__ submit a request body containing a JSON object with the following schema:
```
{
	"user_id": Uuid,
	"seasons": [season1, season2]
}
```
* `season` object __should__ be of following shcema:
```
{
	"sport": string,
	"competition_level": string,
	"start_date": string,
	"end_date": string,
	"positions": [string, string]
}
```
* `start_date` and `end_date` __should__ be of format `yyyy-mm`


```
POST /plans/athlete_seasons HTTPS/1.1
Host: apis.env.fathomai.com
Content-Type: application/json
Authorization: eyJraWQ...ajBc4VQ

{
    "user_id": "02cb7965-7921-493a-80d4-6b278c928fad",
    "seasons": [
            {
               "sport": "soccer",
               "competition_level":  "NCAA div 1",
               "start_date": "2018-06",
               "end_date": "2018-09",
               "positions": ["forward"]
               }
            ]
}
```
##### Responses
 If the write was successful, the Service __will__ respond with HTTP Status `201 Created`, with a body with the following syntax:
 
```
{
    "message": "success"
}
```


